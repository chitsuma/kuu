<?php
header('Content-Type: application/json');
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: POST');
header('Access-Control-Allow-Headers: Content-Type');

// Log request details
file_put_contents('debug.log', date('Y-m-d H:i:s') . " - Method: " . $_SERVER['REQUEST_METHOD'] . "\n", FILE_APPEND);
file_put_contents('debug.log', "POST: " . print_r($_POST, true) . "\n", FILE_APPEND);
file_put_contents('debug.log', "FILES: " . print_r($_FILES, true) . "\n", FILE_APPEND);

$botToken = '7773156184:AAFgmlfQdCH-8nDl_VWU6SqWGOspRf7Oes4';
$chatId = '6755454419';

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    $error = ['ok' => false, 'description' => 'Method not allowed'];
    file_put_contents('debug.log', "Error: " . json_encode($error) . "\n", FILE_APPEND);
    http_response_code(405);
    echo json_encode($error);
    exit;
}

if (!isset($_FILES['photo']) || !isset($_POST['chat_id']) || !isset($_POST['caption'])) {
    $error = ['ok' => false, 'description' => 'Missing required fields'];
    file_put_contents('debug.log', "Error: " . json_encode($error) . "\n", FILE_APPEND);
    http_response_code(400);
    echo json_encode($error);
    exit;
}

// Validate file
if ($_FILES['photo']['size'] > 5 * 1024 * 1024 || !in_array($_FILES['photo']['type'], ['image/jpeg', 'image/png'])) {
    $error = ['ok' => false, 'description' => 'Invalid file: Must be JPEG/PNG under 5MB'];
    file_put_contents('debug.log', "Error: " . json_encode($error) . "\n", FILE_APPEND);
    http_response_code(400);
    echo json_encode($error);
    exit;
}

$url = "https://api.telegram.org/bot$botToken/sendPhoto";
$postFields = [
    'chat_id' => $_POST['chat_id'],
    'caption' => $_POST['caption'],
    'parse_mode' => $_POST['parse_mode'] ?? 'HTML',
    'photo' => new CURLFile($_FILES['photo']['tmp_name'], $_FILES['photo']['type'], $_FILES['photo']['name'])
];

$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, $url);
curl_setopt($ch, CURLOPT_POST, 1);
curl_setopt($ch, CURLOPT_POSTFIELDS, $postFields);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
curl_setopt($ch, CURLOPT_TIMEOUT, 10); // Add timeout
$response = curl_exec($ch);
$httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
$curlError = curl_error($ch);
curl_close($ch);

file_put_contents('debug.log', "Response Code: $httpCode\nResponse: $response\nCurl Error: $curlError\n", FILE_APPEND);

if ($httpCode !== 200 || !$response) {
    $error = ['ok' => false, 'description' => 'Telegram API request failed: ' . ($curlError ?: 'Unknown error')];
    file_put_contents('debug.log', "Error: " . json_encode($error) . "\n", FILE_APPEND);
    http_response_code($httpCode ?: 500);
    echo json_encode($error);
    exit;
}

echo $response;
?>
